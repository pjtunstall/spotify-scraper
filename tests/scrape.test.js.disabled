import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";
import scrape from "../src/scrape/scrape.js";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// `Cannot log after tests are done. Did you forget to wait for something async in your test?`
// It tries to test after each country is scraped, rather than waiting till the end.
describe("scrape function", () => {
  const filePath = path.join(__dirname, "spotify-prices.txt");

  beforeAll(async () => {
    try {
      await fs.unlink(filePath);
    } catch (error) {
      if (error.code !== "ENOENT") throw error;
    }
  });

  afterAll(async () => {
    try {
      await fs.unlink(filePath);
    } catch (error) {
      if (error.code !== "ENOENT") throw error;
    }
  });

  test("scrape writes correct content to the file", async () => {
    const { failedCountries } = await scrape(0);

    const fileContents = await fs.readFile(filePath, "utf8");
    expect(fileContents).toBe(expectedString);
    expect(failedCountries).toEqual([]); // Verify no countries failed
  });
});

const expectedString = `"Albania","5.49","EUR","€5.49/month after"
"Algeria","4.99","USD","4,99 $US/mois ensuite"
"Andorra","10.99","EUR","Después, 10,99 €/mes"
"Angola","2.99","USD","Depois, 2,99 US$/mês"
"Antigua and Barbuda","5.99","USD","US$5.99/month after"
"Argentina","2,499","ARS","Después, cuesta $ 2.499*** al mes"
"Armenia","4.99","USD","US$4.99/month after"
"Australia","13.99","AUD","A$13.99/month after"
"Austria","10.99","EUR","Danach 10,99 €/Monat"
"Azerbaijan","4.99","USD","Sonra aylıq 4,99 US$"
"Bahamas","5.99","USD","US$5.99/month after"
"Bahrain","4.99","USD","US$4.99/month after"
"Bangladesh","199","BDT","BDT 199/month after"
"Barbados","5.99","USD","US$5.99/month after"
"Belarus","4.99","USD","Затем подписка будет стоить 4,99 $ в месяц"
"Belgium","10.99","EUR","Daarna € 10,99 per maand"
"Belize","5.99","USD","US$5.99/month after"
"Benin","2.99","USD","2,99 $US/mois ensuite"
"Bhutan","2.99","USD","US$2.99/month after"
"Bolivia","5.99","USD","Después, 5,99 US$/mes"
"Bosnia and Herzegovina","5.49","EUR","€5.49/month after"
"Botswana","2.99","USD","US$2.99/month after"
"Brazil","21.90","BRL","Depois é só R$ 21,90/mês"
"Brunei Darussalam","6.99","USD","US$6.99/month after"
"Bulgaria","9.99","BGN","9,99 лв./месец след това"
"Burkina Faso","2.99","USD","2,99 $US/mois ensuite"
"Burundi","2.99","BIF","2,99 $US/mois ensuite"
"Cambodia","2.99","USD","US$2.99/month after"
"Cameroon","2.99","USD","2,99 $US/mois ensuite"
"Canada","12.69","CAD","CA$12.69 / month after. Cancel anytime."
"Cape Verde","2.99","USD","Depois, 2,99 US$/mês"
"Chad","2.99","USD","2,99 $US/mois ensuite"
"Chile","4550","CLP","Después, 4550 CLP/mes"
"Colombia","16,900","COP","Después, 16.900 COP/mes"
"Comoros","2.99","USD","2,99 $US/mois ensuite"
"Congo","2.99","USD","2,99 $US/mois ensuite"
"Congo, Democratic Republic","2.99","USD","US$ 2.99 kila mwezi baada ya hapo"
"Costa Rica","6.49","USD","Después, 6,49 US$***/mes"
"Cote D'Ivoire","2.99","USD","2,99 $US/mois ensuite"
"Croatia","6.49","EUR","6,49 € mjesečno nakon"
"Cyprus","7.99","EUR","€7.99/month after"
"Czechia","169","CZK","Potom 169 Kč/měsíc"
"Denmark","109","DKK","Derefter 109 kr./måned"
"Djibouti","2.99","USD","2,99 $US/mois ensuite"
"Dominica","5.99","USD","US$5.99/month after"
"Dominican Republic","5.99","USD","Después, 5,99 US$/mes"
"Ecuador","6.49","USD","Después, 6,49 US$***/mes"
"Egypt","69.99","EGP","EGP 69.99/month after"
"El Salvador","5.99","USD","Después, 5,99 US$/mes"
"Equatorial Guinea","2.99","USD","US$2.99/month after"
"Estonia","9.99","EUR","€9.99/month after"
"Ethiopia","2.99","USD","US$2.99/month after"
"Fiji","4.99","USD","US$4.99/month after"
"Finland","11.99","EUR","Myöhemmin 11,99 €/kk"
"France","11.12","EUR","11,12 €/mois ensuite"
"Gabon","2.99","USD","2,99 $US/mois ensuite"
"Gambia","2.99","USD","US$2.99/month after"
"Georgia","4.99","USD","US$4.99/month after"
"Germany","10.99","EUR","Danach 10,99 €/Monat"
"Ghana","22","GHS","GHS 22/month after"
"Greece","7.99","EUR","7,99 €/μήνα στη συνέχεια"
"Grenada","5.99","USD","US$5.99/month after"
"Guatemala","6.49","USD","Después, 6,49 US$/mes"
"Guinea","2.99","USD","2,99 $US/mois ensuite"
"Guinea-Bissau","2.99","USD","Depois, 2,99 US$/mês"
"Guyana","5.99","USD","US$5.99/month after"
"Haiti","2.99","USD","2,99 $US/mois ensuite"
"Honduras","5.99","USD","Después, 5,99 US$/mes"
"Hong Kong","68","HKD","之後每月 HK$68"
"Hungary","1990","HUF","Utána 1990 Ft/hó"
"Iceland","11.99","EUR","€11.99/month after"
"India","119","INR","₹119/month after"
"Indonesia","54,990","IDR","Rp 54.990/bulan sesudahnya"
"Iraq","4,500","IQD","IQD 4,500/month after"
"Ireland","11.99","EUR","€11.99/month after"
"Israel","21.90","ILS","‏21.90 ‏₪ לחודש לאחר מכן"
"Italy","10.99","EUR","Dopo, 10,99 € al mese"
"Jamaica","5.99","USD","US$5.99/month after"
"Japan","980","JPY","キャンペーン期間終了後は月額￥980"
"Jordan","4.99","USD","US$4.99/month after"
"Kazakhstan","4.99","USD","Затем подписка будет стоить 4,99 $ в месяц"
"Kenya","339","KES","KES 339/month after"
"Kiribati","11.99","AUD","A$11.99/month after"
"Korea","10,900","KRW","체험 기간 종료 후 매월 ₩10,900(부가세 별도) 결제"
"Kuwait","4.99","USD","US$4.99/month after"
"Kyrgyzstan","4.99","USD","Затем подписка будет стоить 4,99 $ в месяц"
"Laos","2.99","USD","US$2.99/month after"
"Latvia","9.99","EUR","Pēc tam – 9,99 € mēnesī"
"Lebanon","4.99","USD","US$4.99/month after"
"Lesotho","2.99","USD","US$2.99/month after"
"Liberia","2.99","USD","US$2.99/month after"
"Libya","2.99","USD","US$2.99/month after"
"Liechtenstein","13.95","CHF","Danach 13,95 CHF/Monat"
"Lithuania","8.99","EUR","Paskui 8,99 € per mėn."
"Luxembourg","10.99","EUR","10,99 €/mois ensuite"
"Macao","6.99","USD","之後每月 US$6.99"
"Macedonia","5.49","EUR","€5.49/month after"
"Madagascar","2.99","USD","2,99 $US/mois ensuite"
"Malawi","2.99","USD","US$2.99/month after"
"Malaysia","15.90","MYR","MYR 15.90/month after"
"Maldives","4.99","USD","US$4.99/month after"
"Mali","2.99","USD","2,99 $US/mois ensuite"
"Malta","7.99","EUR","€7.99/month after"
"Marshall Islands","9.99","USD","$9.99 / month after"
"Mauritania","2.99","USD","US$2.99/month after"
"Mauritius","2.99","USD","US$2.99/month after"
"Mexico","129","MXN","Después, cuesta $129 por mes"
"Micronesia","4.99","USD","US$4.99/month after"
"Moldova","4.99","USD","Затем подписка будет стоить 4,99 $ в месяц"
"Monaco","10.99","EUR","10,99 €/mois ensuite"
"Mongolia","4.99","USD","US$4.99/month after"
"Montenegro","5.49","EUR","€5.49/month after"
"Morocco","40","MAD","40 MAD/mois ensuite"
"Mozambique","2.99","USD","Depois, 2,99 US$/mês"
"Namibia","2.99","USD","US$2.99/month after"
"Nauru","11.99","AUD","A$11.99/month after"
"Nepal","2.99","USD","US$2.99/month after"
"Netherlands","10.99","EUR","Daarna € 10,99 per maand"
"New Zealand","18.99","NZD","NZ$18.99/month after"
"Nicaragua","5.99","USD","Después, 5,99 US$/mes"
"Niger","2.99","USD","2,99 $US/mois ensuite"
"Nigeria","1,300","NGN","NGN 1,300/month after"
"Norway","129","NOK","Deretter 129 kr i måneden"
"Oman","4.99","USD","US$4.99/month after"
"Pakistan","349","PKR","PKR 349/month after"
"Palau","9.99","USD","US$9.99/month after"
"Panama","6.99","USD","Después, 6,99 US$/mes"
"Papua New Guinea","4.99","USD","US$4.99/month after"
"Paraguay","5.99","USD","Después, 5,99 US$***/mes"
"Peru","20.90","PEN","Después, 20,90 PEN/mes"
"Philippines","149","PHP","₱149 / month after"
"Poland","23.99","PLN","Po tym okresie 23,99 zł/miesiąc."
"Qatar","19.99","QAR","QAR 19.99/month after"
"Romania","24","RON","24 RON/lună după"
"Rwanda","2.99","USD","US$2.99/month after"
"Saint Kitts and Nevis","5.99","USD","US$5.99/month after"
"Saint Lucia","5.99","USD","US$5.99/month after"
"Saint Vincent and the Grenadines","5.99","USD","US$5.99/month after"
"Samoa","4.99","USD","US$4.99/month after"
"San Marino","10.99","EUR","Dopo, 10,99 € al mese"
"Sao Tome and Principe","2.99","USD","Depois, 2,99 US$/mês"
"Saudi Arabia","21.99","SAR","SAR 21.99/month after"
"Senegal","2.99","USD","2,99 $US/mois ensuite"
"Serbia","5.49","EUR","Posle toga plaćate 5,49 € mesečno"
"Seychelles","4.99","USD","US$4.99/month after"
"Sierra Leone","2.99","USD","US$2.99/month after"
"Singapore","10.98","SGD","SGD 10.98/month after"
"Slovakia","6.49","EUR","Potom 6,49 €/mesiac"
"Slovenia","6.49","EUR","Nato 6,49 €/mesec"
"Solomon Islands","4.99","USD","US$4.99/month after"
"South Africa","64.99","ZAR","ZAR 64.99/month after"
"Spain","10.99","EUR","Después, 10,99 €/mes"
"Sri Lanka","749","LKR","LKR 749/month after"
"Suriname","5.99","USD","US$5.99/month after"
"Swaziland","2.99","USD","US$2.99/month after"
"Sweden","119","SEK","119 kr/månad därefter"
"Switzerland","13.95","CHF","Danach 13,95 CHF/Monat"
"Taiwan","149","TWD","後續每月只要 $149"
"Tajikistan","4.99","USD","Затем подписка будет стоить 4,99 $ в месяц"
"Tanzania","6,900","TZS","TZS 6,900/month after"
"Thailand","139","THB","฿139/เดือนหลังจากนั้น"
"Timor-Leste","4.99","USD","US$4.99/month after"
"Togo","2.99","USD","2,99 $US/mois ensuite"
"Tonga","4.99","USD","US$4.99/month after"
"Trinidad and Tobago","5.99","USD","US$5.99/month after"
"Tunisia","12.50","TND","12,50 TND/mois ensuite"
"Turkey","59.99","TRY","Sonra ayda ₺59,99"
"Tuvalu","11.99","AUD","A$11.99/month after"
"Uganda","10,000","UGX","UGX 10,000/month after"
"Ukraine","4.99","USD","US$4.99/month after"
"United Arab Emirates","21.99","AED","AED 21.99/month after"
"United Kingdom","11.99","GBP","£11.99/month after"
"United States","11.99","USD","$11.99 / month after"
"Uruguay","7.99","USD","Después, 7,99 US$/mes"
"Uzbekistan","4.99","USD","US$4.99/month after"
"Vanuatu","4.99","USD","US$4.99/month after"
"Venezuela","5.99","USD","Después, 5,99 US$/mes"
"Viet Nam","59,000","VND","Sau đó là 59.000 ₫/tháng."
"Zambia","2.99","USD","US$2.99/month after"
"Zimbabwe","2.99","USD","US$2.99/month after"
`;
